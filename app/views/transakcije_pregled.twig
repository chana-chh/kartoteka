{% extends "templates/app.twig" %}
{% block sadrzaj %}
<style>
  .ikonica {
    position: relative;
    top: -2px;
  }
</style>
<h1 class="uk-text-primary">
  Zaduženja za
  <span class="uk-text-success">{{ staraoc.punoIme() | upper }}</span>
  - <small class="uk-text-muted">
      <a href="{{ path_for('kartoni.pregled', { id: staraoc.karton().id }) }}">[{{ staraoc.karton().broj() }}]</a>
    </small>
</h1>
<div class="uk-panel uk-background-muted uk-padding-small">
  <div class="uk-clearfix">
    <div class="uk-float-left">
      <div class="uk-button-group">
        <a href="{{ path_for('kartoni.pregled', { id: staraoc.karton().id }) }}"
          class="uk-button uk-button-primary uk-button-small uk-margin-right">
          <span uk-icon="chevron-double-left"></span> Karton
        </a>
        <a href="{{ path_for('transakcije.pregled', { id: staraoc.id, z: 0 }) }}"
          class="uk-button uk-button-primary uk-button-small">Sve
        </a>
        <a href="{{ path_for('transakcije.pregled', { id: staraoc.id, z: 1 }) }}"
          class="uk-button uk-button-secondary uk-button-small">Razduženo
        </a>
        <a href="{{ path_for('transakcije.pregled', { id: staraoc.id, z: 2 }) }}"
          class="uk-button uk-button-danger uk-button-small">Nerazduženo
        </a>
      </div>
    </div>
    <div class="uk-float-right">
      <div class="uk-button-group">
        <button class="uk-button uk-button-primary uk-button-small">Zaduživanje</button>
        <div class="uk-inline">
          <button class="uk-button uk-button-primary uk-button-small" type="button"><span
              uk-icon="icon:  triangle-down"></span></button>
          <div uk-dropdown="mode: click; boundary: ! .uk-button-group; boundary-align: true;">
            <ul class="uk-nav uk-dropdown-nav">
              <li>
                <a href="{{ path_for('taksa', { id: karton.id }) }}">
                  <span uk-icon="bookmark"></span>&emsp;Zaduži taksu
                </a>
              </li>
              <li><a href="{{ path_for('zakup', { id: karton.id }) }}">
                  <span uk-icon="bookmark"></span>&emsp;Zaduži zakup
                </a>
              </li>
              <li><a href="{{ path_for('racun', { id: staraoc.id }) }}">
                  <span uk-icon="bookmark"></span>&emsp;Zaduži račun
                </a>
              </li>
            </ul>
          </div>
        </div>
        <a href="{{ path_for('transakcije.razduzivanje', { id: karton.id }) }}"
          class="uk-button uk-button-primary uk-button-small">
          <span uk-icon="database" class="ikonica"></span> Razduživanje
        </a>
        <a href="{{ path_for('uplate', { id: karton.id }) }}" class="uk-button uk-button-primary uk-button-small">
          <span class="uk-badge">{{broj_uplata}}</span> Pregled uplata
        </a>
        <a href="{{ path_for('transakcije.reprogrami', { id: karton.id }) }}"
          class="uk-button uk-button-primary uk-button-small">
          <span uk-icon="refresh" class="ikonica"></span> Reprogrami
        </a>
        <a href="{{ path_for('transakcije.pregled.stampa', { id: karton.id }) }}" target="_blank"
          class="uk-button uk-button-primary uk-button-small">
          <span uk-icon="print" class="ikonica"></span> Štampa
        </a>
      </div>
    </div>
  </div>
</div>

<div class="uk-panel uk-background-muted uk-padding-small uk-margin-small uk-border-rounded">
  {% if zaduzenost == 0 %}
    <p class="uk-text-primary"><strong>SVA ZADUŽENJA</strong></p>
  {% endif %}
  {% if zaduzenost == 1 %}
    <p class="uk-text-success"><strong>RAZDUŽENO</strong></p>
  {% endif %}
  {% if zaduzenost == 2 %}
    <p class="uk-text-danger"><strong>NERAZDUŽENO</strong></p>
  {% endif %}
</div>

<div class="uk-width-1-1 uk-margin-top">
  <ul uk-accordion="multiple: true">
    <li>
      <a class="uk-accordion-title" href="#">
        <h2>
          Takse
          <em class="uk-text-primary">[{{ staraoc.sveTakse() | length }}]</em>
          <em class="uk-text-success">[{{ staraoc.razduzeneTakse() | length }}]</em>
          <em class="uk-text-danger">[{{ staraoc.zaduzeneTakse() | length }}]</em>
          <small><em class="uk-text-danger">[{{ staraoc.dugZaTakse() | number_format(2, '.', ',') }}]</em></small>
        </h2>
      </a>
      <div class="uk-accordion-content">
        <hr>
        <div class="uk-overflow-auto">
          <table class="uk-table uk-table-divider uk-table-striped uk-table-hover uk-table-small">
            <thead>
              <tr>
                <th class="w-5">Godina</th>
                <th class="w-20">Ime</th>
                <th class="w-15 uk-text-right">Iznos (zaduženo)</th>
                <th class="w-15 uk-text-right">Iznos (razduženo)</th>
                <th class="w-15 uk-text-right">Za razduženje</th>
                <th class="w-10 uk-text-center">Razduženo</th>
                <th class="w-15">Reprogram</th>
                <th class="w-5 uk-text-right"><span uk-icon="cog"></span></th>
              </tr>
            </thead>
            <tbody>
              {% set takse =  staraoc.sveTakse() %}
              {% if zaduzenost == 1 %}
                {% set takse =  staraoc.razduzeneTakse() %}
              {% endif %}
              {% if zaduzenost == 2 %}
                {% set takse =  staraoc.zaduzeneTakse() %}
              {% endif %}
              {% for taksa in takse %}
              {% if taksa.razduzeno == 0  %}
              {% set cls = "uk-text-danger" %}
              {% endif %}
              {% if taksa.razduzeno == 1  %}
              {% set cls = "uk-text-success" %}
              {% endif %}
              {% if taksa.reprogram_id %}
              {% set cls = "uk-text-primary" %}
              {% endif %}
              <tr class="{{ cls }}">
                <td>{{ taksa.godina }}</td>
                <td>{{ taksa.staraoc().punoIme() | upper }}</td>
                <td class="uk-text-right">
                  {{ taksa.iznos_zaduzeno | number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-right">
                  {{ taksa.iznos_razduzeno | number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-right">
                  {{ ((cena_takse * staraoc.karton().broj_mesta / staraoc.karton().brojAktivnihStaraoca()) - taksa.iznos_razduzeno) | number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-center">{{ taksa.razduzenoDisabled() | raw }}</td>
                <td>
                  {% if taksa.reprogram_id %}
                  <span uk-icon="refresh"></span> {{ taksa.reprogramLbl(taksa.reprogram_id)|raw }}
                  {% endif %}
                </td>
                <td class="uk-text-right">
                  <a title="Brisanje" href="#modal-brisanje" data-id="{{ taksa.id }}" onclick="setZaduzenjeId(this);"
                    uk-toggle>
                    <span uk-icon="trash"></span>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </li>
    <li>
      <a class="uk-accordion-title" href="#">
        <h2>
          Zakup
          <em class="uk-text-primary">[{{ staraoc.sviZakupi() | length }}]</em>
          <em class="uk-text-success">[{{ staraoc.razduzeniZakupi() | length }}]</em>
          <em class="uk-text-danger">[{{ staraoc.zaduzeniZakupi() | length }}]</em>
          <small><em class="uk-text-danger">[{{ staraoc.dugZaZakupe() | number_format(2, '.', ',') }}]</em></small>
        </h2>
      </a>
      <div class="uk-accordion-content">
        <hr>
        <div class="uk-overflow-auto">
          <table class="uk-table uk-table-divider uk-table-striped uk-table-hover uk-table-small">
            <thead>
              <tr>
                <th class="w-5">Godina</th>
                <th class="w-20">Ime</th>
                <th class="w-15 uk-text-right">Iznos (zaduženo)</th>
                <th class="w-15 uk-text-right">Iznos (razduženo)</th>
                <th class="w-15 uk-text-right">Za razduženje</th>
                <th class="w-10 uk-text-center">Razduženo</th>
                <th class="w-15">Reprogram</th>
                <th class="w-5 uk-text-right"><span uk-icon="cog"></span></th>
              </tr>
            </thead>
            <tbody>
              {% set zakupi =  staraoc.sviZakupi() %}
              {% if zaduzenost == 1 %}
                {% set zakupi =  staraoc.razduzeniZakupi() %}
              {% endif %}
              {% if zaduzenost == 2 %}
                {% set zakupi =  staraoc.zaduzeniZakupi() %}
              {% endif %}
              {% for zakup in zakupi %}
              {% if zakup.razduzeno == 0  %}
              {% set cls = "uk-text-danger" %}
              {% endif %}
              {% if zakup.razduzeno == 1  %}
              {% set cls = "uk-text-success" %}
              {% endif %}
              {% if zakup.reprogram_id %}
              {% set cls = "uk-text-primary" %}
              {% endif %}
              <tr class="{{ cls }}">
                <td>{{ zakup.godina }}</td>
                <td>{{ zakup.staraoc().punoIme() | upper }}</td>
                <td class="uk-text-right">
                  {{ zakup.iznos_zaduzeno | number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-right">
                  {{ zakup.iznos_razduzeno | number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-right">
                  {{ ((cena_zakupa * staraoc.karton().broj_mesta / staraoc.karton().brojAktivnihStaraoca()) - zakup.iznos_razduzeno) | number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-center">{{ zakup.razduzenoDisabled() | raw }}</td>
                <td>
                  {% if zakup.reprogram_id %}
                  <span uk-icon="refresh"></span> {{ zakup.reprogramLbl(zakup.reprogram_id)|raw }}
                  {% endif %}
                </td>
                <td class="uk-text-right">
                  <a title="Brisanje" href="#modal-brisanje" data-id="{{ zakup.id }}" onclick="setZaduzenjeId(this);"
                    uk-toggle>
                    <span uk-icon="trash"></span>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </li>
    <li>
      <a class="uk-accordion-title" href="#">
        <h2>
          Računi
          <em class="uk-text-primary">[{{ staraoc.sviRacuni() | length }}]</em>
          <em class="uk-text-success">[{{ staraoc.razduzeniRacuni() | length }}]</em>
          <em class="uk-text-danger">[{{ staraoc.zaduzeniRacuni() | length }}]</em>
          <small><em class="uk-text-danger">[{{ staraoc.dugZaRacune() | number_format(2, '.', ',') }}]</em></small>
        </h2>
      </a>
      <div class="uk-accordion-content">
        <hr>
        <div class="uk-overflow-auto">
          <table class="uk-table uk-table-divider uk-table-striped uk-table-hover uk-table-small">
            <thead>
              <tr>
                <th class="w-15">Broj</th>
                <th class="w-10">Datum</th>
                <th class="w-20">Ime</th>
                <th class="w-15 uk-text-right">Iznos</th>
                <th class="w-10 uk-text-center">Razduženo</th>
                <th class="w-20">Reprogram</th>
                <th class="w-10 uk-text-right"><span uk-icon="cog"></span></th>
              </tr>
            </thead>
            <tbody>
              {% set racuni =  staraoc.sviRacuni() %}
              {% if zaduzenost == 1 %}
                {% set racuni =  staraoc.razduzeniRacuni() %}
              {% endif %}
              {% if zaduzenost == 2 %}
                {% set racuni =  staraoc.zaduzeniRacuni() %}
              {% endif %}
              {% for rn in racuni %}
              {% if rn.razduzeno == 0  %}
              {% set cls = "uk-text-danger" %}
              {% endif %}
              {% if rn.razduzeno == 1  %}
              {% set cls = "uk-text-success" %}
              {% endif %}
              {% if rn.reprogram_id %}
              {% set cls = "uk-text-primary" %}
              {% endif %}
              <tr class="{{ cls }}">
                <td>{{ rn.broj }}</td>
                <td>{{ rn.datum() }}</td>
                <td>{{ rn.staraoc().punoIme() | upper }}</td>
                <td class="uk-text-right">
                  {{ rn.iznos|number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-center">{{ rn.razduzenoDisabled() | raw }}</td>
                <td>
                  {% if rn.reprogram_id %}
                  <span uk-icon="refresh"></span> {{ rn.reprogramLbl(rn.reprogram_id)|raw }}
                  {% endif %}
                </td>
                {% if auth.logged and auth.user.nivo == 0 %}
                <td class="uk-text-right">
                  <a title="Brisanje" href="#modal-brisanje-racuna" data-id="{{ rn.id }}" onclick="setRacunId(this);"
                    uk-toggle>
                    <span uk-icon="trash"></span>
                  </a>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </li>
    <li>
      <a class="uk-accordion-title" href="#">
        <h2>
          Reprogrami
          <em class="uk-text-success">[{{ karton.reprogrami()|length }}]</em>
          <em class="uk-text-danger">[{{ karton.nerazduzeniReprogrami()|length }}]</em>
        </h2>
      </a>
      <div class="uk-accordion-content">
        <hr>
        <div class="uk-overflow-auto">
          <table class="uk-table uk-table-divider uk-table-striped uk-table-hover uk-table-small">
            <thead>
              <tr>
                <th class="w-20">Broj</th>
                <th class="w-15 uk-text-right">Datum</th>
                <th class="w-15 uk-text-right">Iznos</th>
                <th class="w-20 uk-text-right">Peroid</th>
                <th class="w-20 uk-text-right">Preostalo rata</th>
                <th class="w-10 uk-text-center">Razduženo</th>
              </tr>
            </thead>
            <tbody>
              {% for rep in karton.reprogrami() %}
              {% set cls = "" %}
              {% if rep.razduzeno == 0  %}
              {% set cls = "uk-text-danger" %}
              {% endif %}
              {% if rep.razduzeno == 1  %}
              {% set cls = "uk-text-success" %}
              {% endif %}
              <tr class="{{ cls }}">
                <td>{{ rep.broj }}</td>
                <td class="uk-text-right">{{ rep.datum() }}</td>
                <td class="uk-text-right">
                  {{ rep.iznos|number_format(2, '.', ',') }}
                </td>
                <td class="uk-text-right">
                  {{ rep.period }}
                </td>
                <td class="uk-text-right">
                  {{ rep.preostalo_rata }}
                </td>
                <td class="uk-text-center">{{ rep.razduzenoDisabled() | raw }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </li>
  </ul>
</div>
<!-- MODAL BRISANJE ZADUŽENJA -->
{% include 'inc/zaduzenje_brisanje.twig' %}
<!-- MODAL BRISANJE RAČUNA -->
{% include 'inc/racun_brisanje.twig' %}
{% endblock sadrzaj %}

{% block traka %}
<div uk-grid>

  <div class="uk-width-1-2">
    <h3 class="uk-text-warning"><strong>Stanje zaključno sa {{ "now" | date("Y") }}. godinom</strong></h3>
  </div>
  <div class="uk-width-1-2">
    <h3 class="uk-text-right"><strong>Ukupan dug</strong></h3>
    <div class="uk-panel uk-background-muted uk-padding-small uk-text-large uk-text-bold uk-text-right">
      <h2 class="uk-text-danger" id="ukupan-dug">
        {% set dug = staraoc.dugZaTakse() + staraoc.dugZaZakupe() + staraoc.dugZaRacune() + staraoc.dugZaReprograme() %}
        {{ dug | number_format(2, '.', ',') }}
      </h2>
    </div>
  </div>
  <div class="uk-width-1-2">
    <h3>Dug za takse</h3>
  </div>
  <div class="uk-width-1-2">
    <div class="uk-panel uk-background-muted uk-text-large uk-text-bold uk-text-right">
      <h3 class="uk-text-danger" id="takse-dug">
        {{ staraoc.dugZaTakse() | number_format(2, '.', ',') }}
      </h3>
    </div>
  </div>
  <div class="uk-width-1-2">
    <h3>Dug za zakup</h3>
  </div>
  <div class="uk-width-1-2">
    <div class="uk-panel uk-background-muted uk-text-large uk-text-bold uk-text-right">
      <h3 class="uk-text-danger" id="takse-dug">
        {{ staraoc.dugZaZakupe() | number_format(2, '.', ',') }}
      </h3>
    </div>
  </div>
  <div class="uk-width-1-2">
    <h3>Dug za račune</h3>
  </div>
  <div class="uk-width-1-2">
    <div class="uk-panel uk-background-muted uk-text-large uk-text-bold uk-text-right">
      <h3 class="uk-text-danger" id="takse-dug">
        {{ staraoc.dugZaRacune() | number_format(2, '.', ',') }}
      </h3>
    </div>
  </div>
  <div class="uk-width-1-2">
    <h3>Dug za reprograme</h3>
  </div>
  <div class="uk-width-1-2">
    <div class="uk-panel uk-background-muted uk-text-large uk-text-bold uk-text-right">
      <h3 class="uk-text-danger" id="takse-dug">
        {{ staraoc.dugZaReprograme() | number_format(2, '.', ',') }}
      </h3>
    </div>
  </div>
</div>
{% endblock traka %}

{% block skripta %}
<script>
  document.getElementById("modal_dugme_brisi_racun").addEventListener("click", function () {
    document.getElementById("forma_brisanje_racuna").submit();
  });

  function setRacunId(el) {
    document.getElementById("modal_racun_id").value = el.dataset.id;
  }

  document.getElementById("modal_dugme_brisi").addEventListener("click", function () {
    document.getElementById("forma_brisanje").submit();
  });

  function setZaduzenjeId(el) {
    document.getElementById("modal_zaduzenje_id").value = el.dataset.id;
  }
</script>
{% endblock skripta %}
